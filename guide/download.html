<!DOCTYPE html>
<html lang="zh">
<!--
  This page was created by cndaqiang with the assistance of Claude (Anthropic AI)
  Created: 2025
-->
<head>
<meta charset="UTF-8">
<title>ä¸‹è½½ autowzry-cli æœ€æ–°ç‰ˆæœ¬</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  text-align: center;
  margin-top: 50px;
  background: #f0f2f5;
  padding: 0 20px; /* æ¡Œé¢ç«¯å·¦å³è¾¹è· */
}
h2 {
  color: #333;
  margin-bottom: 30px;
}

/* æŒ‰é’®æ ·å¼ */
.button {
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #28a745; /* ä¸‹è½½æŒ‰é’®ç»¿è‰² */
  color: white;
  border: none;
  padding: 14px 24px;
  font-size: 16px;
  border-radius: 10px;
  cursor: pointer;
  margin: 10px auto;
  width: 90%;         /* å“åº”å¼å®½åº¦ */
  max-width: 400px;   /* å¤§å±é™åˆ¶ */
  min-width: 200px;   /* å°å±é™åˆ¶ */
  text-align: left;
  gap: 10px;
  transition: all 0.2s;
  white-space: nowrap; /* é˜²æ­¢æ–‡æœ¬æ¢è¡Œ */
}
.button:hover {
  opacity: 0.9;
}

/* ä¸åŒç”¨é€”çš„æŒ‰é’®é¢œè‰² */
.button-src { background-color: #fd7e14; }   /* æ©™è‰² */
.button-tutorial { background-color: #007bff; } /* è“è‰² */

/* ä¸‹è½½è¿›åº¦æ¡ */
#progressContainer {
  width: 90%;
  max-width: 400px;
  min-width: 200px;
  height: 20px;
  background: #ddd;
  border-radius: 10px;
  margin: 10px auto 20px auto;
  overflow: hidden;
}
#progressBar {
  height: 100%;
  width: 0%;
  background: #0078d7;
  border-radius: 10px;
  transition: width 0.2s;
}
#status {
  font-size: 14px;
  color: #333;
  margin-top: 5px;
}
#releaseTime {
  font-size: 0.85em;
  opacity: 0.9;
  font-weight: normal;
  margin-left: 4px;
}

/* åº•éƒ¨ç‰ˆæƒä¿¡æ¯ */
footer {
  margin-top: 50px;
  padding: 20px;
  font-size: 14px;
  color: #666;
  border-top: 1px solid #e0e0e0;
}

/* å°å±ä¼˜åŒ–å­—ä½“ */
@media (max-width: 400px) {
  .button {
    font-size: 14px;
    padding: 12px 18px;
  }
  #status {
    font-size: 12px;
  }
  #releaseTime {
    display: none; /* å°å±éšè—æ—¥æœŸ */
  }
}
</style>
</head>
<body>
<header>
    <script>

  // å¦‚æœæ‚¨ä»‹æ„è¢«ç»Ÿè®¡, è¯·è®¿é—®: blockedDomains

  // æ£€æŸ¥ blockedDomains å’Œ allowDomains æ˜¯å¦å®šä¹‰
  const blockedDomains = ["127.0.0.1", "wzry-doc.serv00.net"];
  const allowDomains = ["autowzry.pages.dev", "wzrydoc.readthedocs.io", "cndaqiang.github.io", "wzry-doc.pages.dev"];


  // å°†å½“å‰åŸŸååŠ å…¥åˆ° allowDomains
  if (allowDomains.length === 0) {
    allowDomains.push(window.location.hostname);
  }

  // å®šä¹‰æ£€æŸ¥é»‘åå•å’Œç™½åå•çš„å‡½æ•°
  function isDomainAllowed() {
    return !blockedDomains.includes(window.location.hostname) && allowDomains.includes(window.location.hostname);
  }


  // Google Analytics ç»Ÿè®¡

  function loadGoogleAnalytics() {
    const script = document.createElement('script');
    script.async = true;
    script.src = "https://www.googletagmanager.com/gtag/js?id=G-FLH4L3Q02F";
    document.head.appendChild(script);

    // Google Analytics é…ç½®
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-FLH4L3Q02F');
  }


  // Baidu Tongji ç»Ÿè®¡

  function loadBaiduTongji() {
    var _hmt = _hmt || [];
    (function () {
      const script = document.createElement("script");
      script.src = "//hm.baidu.com/hm.js?76d0fc6b8ffd3901ec51e8bece995b22";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(script, s);
    })();
  }


  // Umami ç»Ÿè®¡

  function loadUmami() {
    const script = document.createElement('script');
    script.defer = true;
    script.src = '//cloud.umami.is/script.js';
    script.setAttribute('data-website-id', '1d2518ba-011c-47f7-bf3d-c2454778ef02');
    document.head.appendChild(script);
  }


  // å¦‚æœå½“å‰åŸŸåå…è®¸åŠ è½½ç»Ÿè®¡è„šæœ¬ï¼ŒæŒ‰éœ€è°ƒç”¨å„ä¸ªç»Ÿè®¡å‡½æ•°
  if (isDomainAllowed()) {
     loadGoogleAnalytics();
     loadBaiduTongji();
     loadUmami();
  }
</script>
</header>

<h2>ä¸‹è½½ autowzry-cli æœ€æ–°ç‰ˆæœ¬</h2>

<!-- Windows ä¸‹è½½ -->
<button id="downloadWin" class="button">ğŸ–¥ï¸ ä¸‹è½½å¯æ‰§è¡ŒåŒ… Windows <span id="releaseTime"></span></button>
<div id="progressContainer"><div id="progressBar"></div></div>
<div id="status">æ­£åœ¨è·å–ç‰ˆæœ¬ä¿¡æ¯...</div>

<!-- Linux/macOS æºç  -->
<button id="downloadSrc" class="button button-src">ğŸ§ ä¸‹è½½æºç  Linux/macOS  </button>

<!-- æ•™ç¨‹æŒ‰é’® -->
<button id="tutorial1" class="button button-tutorial">ğŸ“˜ Windowsç³»ç»Ÿæ•™ç¨‹</button>
<button id="tutorial2" class="button button-tutorial">ğŸ“— æºä»£ç è¿è¡Œæ•™ç¨‹</button>

<!-- å¼•å…¥å¿…è¦çš„åº“ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
/*
 * NPM ä¸‹è½½è¯´æ˜
 * NPM registry API: https://registry.npmjs.org/autowzry-cli
 * è¿”å›åŒ…å«æ‰€æœ‰ç‰ˆæœ¬ä¿¡æ¯çš„ JSON
 *
 * æµç¨‹ï¼šä¸‹è½½ .tgz â†’ è§£å‹ gzip â†’ è§£æ tar â†’ è½¬ä¸º zip
 */

// âœ… ç¼“å­˜ NPM æ•°æ®ï¼Œé¿å…é‡å¤è¯·æ±‚
let cachedData = null;
let currentRegistry = null; // å½“å‰å¯ç”¨çš„ registry

// âœ… é•œåƒç«™åˆ—è¡¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
const registries = [
  { name: 'NPM å®˜æ–¹', url: 'https://registry.npmjs.org' },
  { name: 'é˜¿é‡Œäº‘é•œåƒ', url: 'https://registry.npmmirror.com' },
  { name: 'è…¾è®¯äº‘é•œåƒ', url: 'https://mirrors.cloud.tencent.com/npm' }
];

// âœ… ä» NPM è·å–æ•°æ®
async function fetchFromSource(url, timeout = 5000) {
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), timeout);

  try {
    const resp = await fetch(url, {
      cache: 'no-store',
      signal: controller.signal
    });
    clearTimeout(timer);
    return await resp.json();
  } catch (err) {
    clearTimeout(timer);
    throw err;
  }
}

// âœ… è·å–å¹¶æ˜¾ç¤ºç‰ˆæœ¬å‘å¸ƒæ—¶é—´
async function fetchVersionInfo() {
  const status = document.getElementById('status');
  const downloadBtn = document.getElementById('downloadWin');

  status.textContent = 'æ­£åœ¨è·å–ç‰ˆæœ¬ä¿¡æ¯...';

  // ä¾æ¬¡å°è¯•å„ä¸ª registry
  for (const registry of registries) {
    try {
      console.log(`æ­£åœ¨å°è¯• ${registry.name}: ${registry.url}`);

      const data = await fetchFromSource(`${registry.url}/autowzry-cli?ts=${Date.now()}`, 3000);

      // æˆåŠŸè·å–æ•°æ®
      cachedData = data;
      currentRegistry = registry;
      console.log(`âœ“ æˆåŠŸä» ${registry.name} è·å–æ•°æ®`);

      // è·å– latest ç‰ˆæœ¬
      const latestVersion = data['dist-tags']?.latest || Object.keys(data.versions).pop();
      const versionData = data.versions[latestVersion];
      console.log('ç‰ˆæœ¬å·:', latestVersion);

      // æ˜¾ç¤ºå‘å¸ƒæ—¶é—´
      const time = data.time?.[latestVersion];
      if (time) {
        const uploadDate = new Date(time);
        const formattedDate = uploadDate.toLocaleDateString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        }).replace(/\//g, '/');
        document.getElementById('releaseTime').textContent = `(${formattedDate})`;
      } else {
        document.getElementById('releaseTime').textContent = '';
      }

      // æ›´æ–°ä¸‹è½½æŒ‰é’®æ–‡æœ¬å’ŒçŠ¶æ€æç¤º
      if (registry.name === 'NPM å®˜æ–¹') {
        downloadBtn.innerHTML = `ğŸ–¥ï¸ ä¸‹è½½å¯æ‰§è¡ŒåŒ… Windows <span id="releaseTime">${document.getElementById('releaseTime').textContent}</span>`;
        status.textContent = 'å‡†å¤‡ä¸‹è½½...';
      } else {
        downloadBtn.innerHTML = `ğŸ–¥ï¸ ä¸‹è½½å¯æ‰§è¡ŒåŒ… Windows (${registry.name}) <span id="releaseTime">${document.getElementById('releaseTime').textContent}</span>`;
        status.textContent = `å‡†å¤‡ä»${registry.name}ä¸‹è½½...`;
      }

      return; // æˆåŠŸåç›´æ¥è¿”å›

    } catch (err) {
      console.log(`âœ— ${registry.name} å¤±è´¥:`, err.message);
      // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª
    }
  }

  // æ‰€æœ‰é•œåƒéƒ½å¤±è´¥
  console.error('æ‰€æœ‰é•œåƒç«™éƒ½æ— æ³•è®¿é—®');
  status.textContent = 'âš ï¸ æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¯·åˆ‡æ¢ç½‘ç»œç¯å¢ƒ';
  document.getElementById('releaseTime').textContent = '';
  cachedData = null;
  currentRegistry = null;
}

// âœ… ç®€å•çš„ tar è§£æå™¨
function parseTar(buffer) {
  const files = [];
  let offset = 0;

  while (offset < buffer.length) {
    const header = buffer.slice(offset, offset + 512);

    // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾æ–‡ä»¶æœ«å°¾ï¼ˆå…¨é›¶å—ï¼‰
    if (header.every(b => b === 0)) break;

    // è¯»å–æ–‡ä»¶å
    const nameBytes = header.slice(0, 100);
    const nameEnd = nameBytes.indexOf(0);
    const name = new TextDecoder().decode(nameBytes.slice(0, nameEnd > 0 ? nameEnd : 100));

    // è¯»å–æ–‡ä»¶å¤§å°ï¼ˆå…«è¿›åˆ¶ï¼‰
    const sizeBytes = header.slice(124, 136);
    const sizeStr = new TextDecoder().decode(sizeBytes).trim().replace(/\0/g, '');
    const size = parseInt(sizeStr, 8) || 0;

    // è¯»å–æ–‡ä»¶ç±»å‹
    const type = String.fromCharCode(header[156]);

    offset += 512;

    // å¦‚æœæ˜¯æ™®é€šæ–‡ä»¶ï¼ˆtype '0' æˆ– '\0'ï¼‰
    if ((type === '0' || type === '\0') && size > 0) {
      const content = buffer.slice(offset, offset + size);
      files.push({ name, content });
    }

    // è·³è¿‡æ–‡ä»¶å†…å®¹ï¼ˆæŒ‰ 512 å­—èŠ‚å¯¹é½ï¼‰
    offset += Math.ceil(size / 512) * 512;
  }

  return files;
}

// âœ… ä¸‹è½½å¹¶è½¬æ¢ä¸º zip
async function downloadWithProgress(url, filename) {
  const status = document.getElementById('status');
  const progressBar = document.getElementById('progressBar');
  status.textContent = 'å¼€å§‹ä¸‹è½½...';
  progressBar.style.width = '0%';

  // 1. ä¸‹è½½ tgz æ–‡ä»¶
  const resp = await fetch(url);
  if (!resp.ok) throw new Error('ä¸‹è½½å¤±è´¥');

  const contentLength = resp.headers.get('Content-Length');
  const total = contentLength ? parseInt(contentLength, 10) : 0;

  const reader = resp.body.getReader();
  const chunks = [];
  let received = 0;

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    chunks.push(value);
    received += value.length;
    if (total) {
      const percent = ((received / total) * 100).toFixed(1);
      status.textContent = `ä¸‹è½½ä¸­(è¯·å‹¿å…³é—­å½“å‰é¡µé¢)ï¼š${percent}%`;
      progressBar.style.width = `${percent}%`;
    } else {
      status.textContent = `ä¸‹è½½ä¸­(è¯·å‹¿å…³é—­å½“å‰é¡µé¢)ï¼š${(received / 1024).toFixed(1)} KB`;
    }
  }

  // 2. è§£å‹ gzip
  status.textContent = 'æ­£åœ¨è§£å‹ gzip...';
  const tgzData = new Uint8Array(await new Blob(chunks).arrayBuffer());
  const tarData = pako.inflate(tgzData);

  // 3. è§£æ tar
  status.textContent = 'æ­£åœ¨è§£æ tar...';
  const files = parseTar(tarData);

  // 4. åˆ›å»º zip
  status.textContent = 'æ­£åœ¨åˆ›å»º zip...';
  const zip = new JSZip();

  for (const file of files) {
    // ç§»é™¤ package/ å‰ç¼€
    const cleanName = file.name.replace(/^package\//, '');
    if (cleanName) {
      zip.file(cleanName, file.content);
    }
  }

  // 5. ç”Ÿæˆ zip å¹¶ä¸‹è½½
  status.textContent = 'æ­£åœ¨ç”Ÿæˆæ–‡ä»¶...';
  const zipBlob = await zip.generateAsync({ type: 'blob' });

  const a = document.createElement('a');
  a.href = URL.createObjectURL(zipBlob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);

  status.textContent = 'ä¸‹è½½å®Œæˆï¼';
  progressBar.style.width = '100%';
}

// âœ… Windows ä¸‹è½½æŒ‰é’®
async function downloadWinLatest() {
  // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜æ•°æ®å’Œå¯ç”¨çš„ registry
  if (!cachedData || !currentRegistry) {
    alert('æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¯·ç¡®ä¿ç½‘ç»œå¯ä»¥è®¿é—® NPM registry');
    return;
  }

  try {
    // è·å– latest ç‰ˆæœ¬çš„ tarball URL
    const latestVersion = cachedData['dist-tags']?.latest || Object.keys(cachedData.versions).pop();
    const versionData = cachedData.versions[latestVersion];
    let tarballUrl = versionData.dist.tarball;

    // å¦‚æœä½¿ç”¨é•œåƒç«™ï¼Œéœ€è¦æ›¿æ¢ tarball URL çš„åŸŸå
    if (currentRegistry.name !== 'NPM å®˜æ–¹') {
      // å°†å®˜æ–¹ URL æ›¿æ¢ä¸ºé•œåƒç«™ URL
      tarballUrl = tarballUrl.replace('https://registry.npmjs.org', currentRegistry.url);
    }

    if (!tarballUrl) {
      alert('æœªæ‰¾åˆ° NPM åŒ…æ–‡ä»¶');
      return;
    }

    const filename = `autowzry-cli-${latestVersion}.zip`;

    console.log(`å¼€å§‹ä» ${currentRegistry.name} ä¸‹è½½:`, tarballUrl);
    await downloadWithProgress(tarballUrl, filename);
  } catch (err) {
    console.error('ä¸‹è½½å¤±è´¥:', err);
    alert('ä¸‹è½½å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
  }
}

// âœ… Linux/macOS æºç ä¸‹è½½ï¼ˆå›ºå®š URLï¼‰
function downloadSrc() {
  window.open("https://github.com/cndaqiang/autowzry/tree/dev", "_blank");
}

// âœ… æ•™ç¨‹è·³è½¬
function openTutorial1() {
  window.open("https://cndaqiang.github.io/wzry.doc/guide/install/", "_blank");
}
function openTutorial2() {
  window.open("https://cndaqiang.github.io/wzry.doc/guide/pyinstall/", "_blank");
}

// ç»‘å®šæŒ‰é’®
document.getElementById('downloadWin').addEventListener('click', downloadWinLatest);
document.getElementById('downloadSrc').addEventListener('click', downloadSrc);
document.getElementById('tutorial1').addEventListener('click', openTutorial1);
document.getElementById('tutorial2').addEventListener('click', openTutorial2);

// é¡µé¢åŠ è½½æ—¶è·å–ç‰ˆæœ¬ä¿¡æ¯
fetchVersionInfo();
</script>

<footer>
  <p>Copyright Â© 2025 AUTOWZRY</p>
</footer>

</body>
</html>
